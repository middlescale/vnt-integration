name: integration

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]
  repository_dispatch:
    types: [ vnt_push, vnts_push ]
  workflow_dispatch:
    inputs:
      vnt_ref:
        description: "vnt ref (branch/tag/sha)"
        default: "main"
      vnts_ref:
        description: "vnts ref (branch/tag/sha)"
        default: "main"

jobs:
  main:
    if: github.event_name != 'release'
    runs-on: ubuntu-latest
    env:
      VNT_REPO: middlescale/vnt
      VNTS_REPO: middlescale/vnts
      VNT_REF: ${{ github.event.client_payload.vnt_ref || inputs.vnt_ref || 'main' }}
      VNTS_REF: ${{ github.event.client_payload.vnts_ref || inputs.vnts_ref || 'main' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.VNT_REPO }}
          path: vnt
          ref: ${{ env.VNT_REF }}
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.VNTS_REPO }}
          path: vnts
          ref: ${{ env.VNTS_REF }}
      - run: docker compose run --rm builder
      - run: docker compose up -d vnts client1 client2
      - run: |
          set -euo pipefail
          strip_ansi() { sed -r 's/\x1b\[[0-9;]*m//g'; }
          wait_for_peer_ip() {
            local service="$1"
            local peer="$2"
            local ip=""
            for _ in $(seq 1 40); do
              ip="$(docker compose exec -T "$service" /workspace/bin/vnt-cli --list 2>/dev/null | strip_ansi | awk -v name="$peer" 'NR>1 && $1==name {print $2; exit}')"
              if [ -n "$ip" ]; then
                echo "$ip"
                return 0
              fi
              sleep 2
            done
            return 1
          }

          client2_ip="$(wait_for_peer_ip client1 client2)"
          client1_ip="$(wait_for_peer_ip client2 client1)"

          docker compose exec -T client1 ping -c 3 "$client2_ip"
          docker compose exec -T client2 ping -c 3 "$client1_ip"
      - if: always()
        run: docker compose down -v

  release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    env:
      VNT_REPO: middlescale/vnt
      VNTS_REPO: middlescale/vnts
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.VNT_REPO }}
          path: vnt
          ref: ${{ github.event.release.tag_name }}
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.VNTS_REPO }}
          path: vnts
          ref: ${{ github.event.release.tag_name }}
      - run: docker compose run --rm builder
      - run: docker compose up -d vnts client1 client2
      - run: |
          set -euo pipefail
          strip_ansi() { sed -r 's/\x1b\[[0-9;]*m//g'; }
          wait_for_peer_ip() {
            local service="$1"
            local peer="$2"
            local ip=""
            for _ in $(seq 1 40); do
              ip="$(docker compose exec -T "$service" /workspace/bin/vnt-cli --list 2>/dev/null | strip_ansi | awk -v name="$peer" 'NR>1 && $1==name {print $2; exit}')"
              if [ -n "$ip" ]; then
                echo "$ip"
                return 0
              fi
              sleep 2
            done
            return 1
          }

          client2_ip="$(wait_for_peer_ip client1 client2)"
          client1_ip="$(wait_for_peer_ip client2 client1)"

          docker compose exec -T client1 ping -c 3 "$client2_ip"
          docker compose exec -T client2 ping -c 3 "$client1_ip"
      - if: always()
        run: docker compose down -v
